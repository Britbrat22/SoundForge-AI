<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal DAW - Complete Music Production Studio</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéµ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
        }

        /* Main Layout */
        .daw-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: #1a1a1a;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
        }

        .transport-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .transport-btn {
            background: #333;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .transport-btn:hover {
            background: #555;
        }

        .transport-btn.active {
            background: #ff6b6b;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #151515;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #888;
        }

        .track-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #333;
            border-color: #666;
        }

        /* Track Area */
        .track-area {
            flex: 1;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
        }

        .track-header {
            background: #1a1a1a;
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .track-controls-main {
            display: flex;
            gap: 15px;
        }

        .add-track-btn {
            background: #ff6b6b;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .timeline-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .tracks-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .track {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .track-info {
            min-width: 200px;
        }

        .track-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .track-controls-track {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .track-btn {
            background: #333;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .track-btn:hover {
            background: #555;
        }

        .track-btn.active {
            background: #ff6b6b;
        }

        .track-waveform {
            flex: 1;
            height: 60px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .waveform-visual {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
            opacity: 0.3;
        }

        /* Beat Maker */
        .beat-maker {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333;
            z-index: 999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .beat-maker.active {
            display: block;
        }

        .beat-pads {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .beat-pad {
            width: 80px;
            height: 80px;
            background: #333;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s ease;
            user-select: none;
        }

        .beat-pad:hover {
            background: #444;
            border-color: #777;
            transform: scale(1.05);
        }

        .beat-pad.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        /* Download Section */
        .download-section {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .download-btn {
            background: #4ecdc4;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #45b7d1;
            transform: translateY(-2px);
        }

        .download-info {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }

        /* Recording Indicator */
        .recording-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff3333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            animation: pulse 1s infinite;
            z-index: 1000;
        }

        .recording-indicator.active {
            display: block;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Audio Element for Playback */
        .audio-player {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .track-info {
                min-width: 150px;
            }
            
            .beat-pad {
                width: 60px;
                height: 60px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="daw-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">üéµ Universal DAW</div>
            <div class="transport-controls">
                <button class="transport-btn" id="playBtn">‚ñ∂Ô∏è Play</button>
                <button class="transport-btn" id="stopBtn">‚èπÔ∏è Stop</button>
                <button class="transport-btn" id="recordBtn">üî¥ Record</button>
                <button class="transport-btn" id="loopBtn">üîÅ Loop</button>
                <button class="transport-btn" id="downloadMasterBtn">üíæ Download</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">TRACK CONTROLS</div>
                    <div class="track-controls">
                        <button class="control-btn" id="addTrackBtn">‚ûï Add Track</button>
                        <button class="control-btn" id="importAudioBtn">üìÅ Import Audio</button>
                        <button class="control-btn" id="beatMakerBtn">ü•Å Beat Maker</button>
                        <button class="control-btn" id="vocalEffectsBtn">üé§ Vocal Effects</button>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">EDITING TOOLS</div>
                    <div class="track-controls">
                        <button class="control-btn" id="splitToolBtn">‚úÇÔ∏è Split Tool</button>
                        <button class="control-btn" id="copyToolBtn">üìã Copy</button>
                        <button class="control-btn" id="pasteToolBtn">üìå Paste</button>
                        <button class="control-btn" id="deleteToolBtn">üóëÔ∏è Delete</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">MASTERING</div>
                    <div class="effects-panel">
                        <div class="effect-control">
                            <label class="effect-label">Master Volume</label>
                            <input type="range" class="effect-slider" min="0" max="100" value="75" id="masterVolume">
                        </div>
                        <div class="effect-control">
                            <label class="effect-label">Bass</label>
                            <input type="range" class="effect-slider" min="0" max="100" value="50" id="masterBass">
                        </div>
                        <div class="effect-control">
                            <label class="effect-label">Treble</label>
                            <input type="range" class="effect-slider" min="0" max="100" value="50" id="masterTreble">
                        </div>
                        <div class="effect-control">
                            <label class="effect-label">Reverb</label>
                            <input type="range" class="effect-slider" min="0" max="100" value="25" id="masterReverb">
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">EXPORT</div>
                    <div class="download-section">
                        <button class="download-btn" id="exportWAVBtn">üîä Export WAV</button>
                        <button class="download-btn" id="exportMP3Btn">üéµ Export MP3</button>
                        <div class="download-info">
                            Export your mixed audio as downloadable files
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Track Area -->
            <main class="track-area">
                <div class="track-header">
                    <div class="track-controls-main">
                        <button class="add-track-btn" id="mainAddTrackBtn">+ Add New Track</button>
                        <span class="timeline-info">Timeline: <span id="timeDisplay">00:00</span></span>
                    </div>
                    <div class="timeline-info">
                        <span>BPM: <input type="number" value="120" min="60" max="200" id="bpmInput" style="width: 60px; background: #333; color: white; border: none; padding: 4px; border-radius: 4px;"></span>
                    </div>
                </div>
                
                <div class="tracks-container" id="tracksContainer">
                    <!-- Tracks will be dynamically added here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Beat Maker -->
    <div class="beat-maker" id="beatMaker">
        <h3>ü•Å Beat Maker</h3>
        <div class="beat-pads">
            <div class="beat-pad" data-sound="kick">Kick</div>
            <div class="beat-pad" data-sound="snare">Snare</div>
            <div class="beat-pad" data-sound="hihat">Hi-Hat</div>
            <div class="beat-pad" data-sound="clap">Clap</div>
            <div class="beat-pad" data-sound="tom">Tom</div>
            <div class="beat-pad" data-sound="crash">Crash</div>
            <div class="beat-pad" data-sound="ride">Ride</div>
            <div class="beat-pad" data-sound="openhat">Open Hat</div>
        </div>
        <button class="transport-btn" id="closeBeatMakerBtn" style="margin-top: 20px;">Close Beat Maker</button>
    </div>

    <!-- Recording Indicator -->
    <div class="recording-indicator" id="recordingIndicator">
        üî¥ RECORDING...
    </div>

    <!-- Hidden Audio Elements -->
    <div class="audio-player" id="audioPlayers"></div>

    <script>
        // GLOBAL VARIABLES
        let isPlaying = false;
        let isRecording = false;
        let trackCount = 0;
        let audioContext;
        let mediaRecorder;
        let recordedChunks = [];
        let currentlyPlayingAudio = null;
        let currentPlayButton = null;
        let allTracks = []; // Store all track data
        let playbackTime = 0;
        let playInterval = null;

        // INITIALIZE AUDIO CONTEXT
        function initAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('Audio context initialized:', audioContext.state);
        }

        // ADD TRACK FUNCTION
        function addTrack(type = 'audio', fileName = null, audioUrl = null) {
            trackCount++;
            const tracksContainer = document.getElementById('tracksContainer');
            
            const trackDiv = document.createElement('div');
            trackDiv.className = 'track';
            trackDiv.id = `track_${trackCount}`;
            
            const displayName = fileName || `Track ${trackCount} (${type})`;
            
            trackDiv.innerHTML = `
                <div class="track-info">
                    <div class="track-name">${displayName}</div>
                    <div class="track-controls-track">
                        <button class="track-btn" onclick="toggleMute(this)">üîá Mute</button>
                        <button class="track-btn" onclick="toggleSolo(this)">üéµ Solo</button>
                        ${audioUrl ? `
                            <button class="track-btn" onclick="playUploadedAudio('${audioUrl}', this)">‚ñ∂Ô∏è Play</button>
                            <button class="track-btn" onclick="stopUploadedAudio(this)">‚èπÔ∏è Stop</button>
                        ` : `
                            <button class="track-btn" onclick="recordTrack(this)">üî¥ Record</button>
                        `}
                        <button class="track-btn" onclick="deleteTrack('track_${trackCount}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
                <div class="track-waveform">
                    <div class="waveform-visual"></div>
                </div>
            `;
            
            tracksContainer.appendChild(trackDiv);
            
            // Store track data
            allTracks.push({
                id: `track_${trackCount}`,
                name: displayName,
                type: type,
                audioUrl: audioUrl,
                muted: false,
                solo: false
            });
            
            console.log('Track added:', displayName, 'Type:', type);
        }

        // FILE UPLOAD FUNCTION (FIXED)
        document.getElementById('importAudioBtn').addEventListener('click', function() {
            console.log('Import audio button clicked');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'audio/*';
            input.multiple = true; // Allow multiple files
            
            input.onchange = function(e) {
                console.log('Files selected:', e.target.files.length);
                
                for (let file of e.target.files) {
                    console.log('Processing file:', file.name, 'Type:', file.type, 'Size:', file.size);
                    
                    // Validate file type
                    if (!file.type.startsWith('audio/')) {
                        alert(`File ${file.name} is not an audio file`);
                        continue;
                    }
                    
                    // Create URL for the audio file
                    const audioUrl = URL.createObjectURL(file);
                    
                    // Add the track
                    addTrack('uploaded', file.name, audioUrl);
                    console.log('Added track for file:', file.name);
                }
            };
            
            input.click();
        });

        // AUDIO PLAYBACK FUNCTIONS (FIXED)
        function playUploadedAudio(audioUrl, button) {
            console.log('Playing audio:', audioUrl);
            
            try {
                // Stop any currently playing audio
                if (currentlyPlayingAudio) {
                    currentlyPlayingAudio.pause();
                    currentlyPlayingAudio.currentTime = 0;
                    if (currentPlayButton) {
                        currentPlayButton.textContent = '‚ñ∂Ô∏è Play';
                    }
                }
                
                // Create new audio element
                const audio = new Audio(audioUrl);
                
                // Set up event listeners
                audio.addEventListener('play', function() {
                    console.log('Audio started playing');
                    button.textContent = '‚è∏Ô∏è Pause';
                    button.classList.add('active');
                    currentPlayButton = button;
                });
                
                audio.addEventListener('pause', function() {
                    console.log('Audio paused');
                    button.textContent = '‚ñ∂Ô∏è Play';
                    button.classList.remove('active');
                });
                
                audio.addEventListener('ended', function() {
                    console.log('Audio finished');
                    button.textContent = '‚ñ∂Ô∏è Play';
                    button.classList.remove('active');
                    currentlyPlayingAudio = null;
                    currentPlayButton = null;
                });
                
                audio.addEventListener('error', function(e) {
                    console.error('Audio playback error:', e);
                    alert('Error playing audio. The file format might not be supported.');
                    button.textContent = '‚ñ∂Ô∏è Play';
                    button.classList.remove('active');
                });
                
                // Try to play the audio
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('Audio playback started successfully');
                        currentlyPlayingAudio = audio;
                    }).catch(err => {
                        console.error('Audio play failed:', err);
                        alert('Failed to play audio: ' + err.message + '\n\nTry clicking the play button again or use a different audio file.');
                        button.textContent = '‚ñ∂Ô∏è Play';
                        button.classList.remove('active');
                    });
                }
                
            } catch (err) {
                console.error('Playback setup error:', err);
                alert('Error setting up audio playback: ' + err.message);
            }
        }

        function stopUploadedAudio(button) {
            if (currentlyPlayingAudio) {
                currentlyPlayingAudio.pause();
                currentlyPlayingAudio.currentTime = 0;
                currentlyPlayingAudio = null;
                
                // Reset all play buttons
                document.querySelectorAll('.track-btn').forEach(btn => {
                    if (btn.textContent.includes('‚è∏Ô∏è')) {
                        btn.textContent = '‚ñ∂Ô∏è Play';
                        btn.classList.remove('active');
                    }
                });
                
                currentPlayButton = null;
            }
        }

        // BEAT MAKER FUNCTIONS (ENHANCED)
        document.getElementById('beatMakerBtn').addEventListener('click', function() {
            document.getElementById('beatMaker').classList.add('active');
        });

        document.getElementById('closeBeatMakerBtn').addEventListener('click', function() {
            document.getElementById('beatMaker').classList.remove('active');
        });

        // ENHANCED DRUM SOUNDS
        document.querySelectorAll('.beat-pad').forEach(pad => {
            pad.addEventListener('click', function() {
                this.classList.add('active');
                setTimeout(() => this.classList.remove('active'), 200);
                
                playEnhancedDrumSound(this.dataset.sound);
            });
        });

        function playEnhancedDrumSound(sound) {
            if (!audioContext) initAudioContext();
            
            // Resume audio context if suspended (required by browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filterNode = audioContext.createBiquadFilter();
            
            oscillator.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            const drumSounds = {
                kick: { frequency: 60, type: 'sine', filterFreq: 100, duration: 0.3, gain: 0.6 },
                snare: { frequency: 200, type: 'triangle', filterFreq: 1000, duration: 0.15, gain: 0.4 },
                hihat: { frequency: 800, type: 'square', filterFreq: 5000, duration: 0.05, gain: 0.3 },
                clap: { frequency: 300, type: 'sawtooth', filterFreq: 2000, duration: 0.1, gain: 0.4 },
                tom: { frequency: 150, type: 'sine', filterFreq: 300, duration: 0.2, gain: 0.5 },
                crash: { frequency: 400, type: 'sawtooth', filterFreq: 8000, duration: 0.5, gain: 0.3 },
                ride: { frequency: 600, type: 'triangle', filterFreq: 4000, duration: 0.3, gain: 0.35 },
                openhat: { frequency: 1000, type: 'square', filterFreq: 6000, duration: 0.2, gain: 0.25 }
            };
            
            const config = drumSounds[sound] || drumSounds.kick;
            
            oscillator.frequency.setValueAtTime(config.frequency, audioContext.currentTime);
            oscillator.type = config.type;
            
            filterNode.frequency.setValueAtTime(config.filterFreq, audioContext.currentTime);
            filterNode.type = 'lowpass';
            
            gainNode.gain.setValueAtTime(config.gain, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + config.duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + config.duration);
            
            // Add noise for snare/hi-hat
            if (sound === 'snare' || sound === 'hihat' || sound === 'clap') {
                addNoise(config.duration, 0.2);
            }
        }

        function addNoise(duration, gain) {
            const bufferSize = audioContext.sampleRate * duration;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            const noiseSource = audioContext.createBufferSource();
            const noiseGain = audioContext.createGain();
            
            noiseSource.buffer = buffer;
            noiseSource.connect(noiseGain);
            noiseGain.connect(audioContext.destination);
            
            noiseGain.gain.setValueAtTime(gain, audioContext.currentTime);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            noiseSource.start(audioContext.currentTime);
            noiseSource.stop(audioContext.currentTime + duration);
        }

        // RECORDING FUNCTIONS (ENHANCED)
        document.getElementById('recordBtn').addEventListener('click', function() {
            isRecording = !isRecording;
            this.classList.toggle('active', isRecording);
            document.getElementById('recordingIndicator').classList.toggle('active', isRecording);
            
            if (isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        async function startRecording() {
            try {
                console.log('Starting recording...');
                
                // Get user media with audio constraints
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100,
                        channelCount: 2
                    } 
                });
                
                // Create media recorder
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });
                
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        console.log('Recorded chunk:', event.data.size, 'bytes');
                    }
                };

                mediaRecorder.onstop = () => {
                    console.log('Recording stopped. Total chunks:', recordedChunks.length);
                    
                    if (recordedChunks.length > 0) {
                        const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        // Create a more descriptive name
                        const timestamp = new Date().toLocaleTimeString();
                        const trackName = `Recording_${timestamp.replace(/:/g, '-')}`;
                        
                        addTrack('recording', trackName, audioUrl);
                        console.log('Recording track added:', trackName);
                    } else {
                        console.warn('No audio data recorded');
                        alert('No audio was recorded. Please check your microphone settings.');
                    }
                    
                    // Clean up the stream
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.onerror = (event) => {
                    console.error('Recording error:', event);
                    alert('Recording error occurred');
                    stream.getTracks().forEach(track => track.stop());
                };

                // Start recording
                mediaRecorder.start(1000); // Collect data every second
                console.log('Recording started');
                
                // Update UI
                document.getElementById('recordBtn').style.background = '#ff6666';
                document.getElementById('recordBtn').textContent = '‚èπ Stop';
                
            } catch (err) {
                console.error('Recording failed:', err);
                let errorMsg = 'Recording failed: ' + err.message;
                
                if (err.name === 'NotAllowedError') {
                    errorMsg = 'Microphone access denied. Please allow microphone access and try again.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg = 'No microphone found. Please connect a microphone and try again.';
                } else if (err.name === 'SecurityError') {
                    errorMsg = 'Recording is not allowed on this page. Please use HTTPS or localhost.';
                }
                
                alert(errorMsg);
                isRecording = false;
                document.getElementById('recordBtn').classList.remove('active');
                document.getElementById('recordingIndicator').classList.remove('active');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                console.log('Stopping recording...');
            }
            
            // Reset UI
            document.getElementById('recordBtn').style.background = '';
            document.getElementById('recordBtn').textContent = 'üî¥ Record';
        }

        // EXPORT FUNCTIONS (NEW)
        document.getElementById('exportWAVBtn').addEventListener('click', function() {
            exportAudio('wav');
        });

        document.getElementById('exportMP3Btn').addEventListener('click', function() {
            exportAudio('mp3');
        });

        function exportAudio(format) {
            console.log('Exporting audio as', format);
            
            if (allTracks.length === 0) {
                alert('No tracks to export. Please add some audio tracks first.');
                return;
            }
            
            // For this demo, we'll export the first track with audio
            const audioTracks = allTracks.filter(track => track.audioUrl);
            
            if (audioTracks.length === 0) {
                alert('No audio tracks to export. Please import or record some audio first.');
                return;
            }
            
            // Get the first audio track
            const trackToExport = audioTracks[0];
            
            // Create download link
            const link = document.createElement('a');
            link.href = trackToExport.audioUrl;
            link.download = `UniversalDAW_${trackToExport.name}_${Date.now()}.${format}`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('Download started for:', trackToExport.name);
            alert(`Downloading ${trackToExport.name} as ${format.toUpperCase()} file...`);
        }

        // MASTER DOWNLOAD (NEW)
        document.getElementById('downloadMasterBtn').addEventListener('click', function() {
            exportMasterAudio();
        });

        function exportMasterAudio() {
            console.log('Exporting master audio...');
            
            if (allTracks.length === 0) {
                alert('No tracks to export. Please add some audio tracks first.');
                return;
            }
            
            // For this demo, we'll create a simple zip-like approach
            // In a real implementation, you'd mix all tracks together
            const audioTracks = allTracks.filter(track => track.audioUrl);
            
            if (audioTracks.length === 0) {
                alert('No audio tracks to export. Please import or record some audio first.');
                return;
            }
            
            if (audioTracks.length === 1) {
                // Single track - download directly
                const link = document.createElement('a');
                link.href = audioTracks[0].audioUrl;
                link.download = `UniversalDAW_Mix_${Date.now()}.wav`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`Downloading mixed audio: ${audioTracks[0].name}`);
            } else {
                // Multiple tracks - download each one
                let downloadCount = 0;
                audioTracks.forEach((track, index) => {
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = track.audioUrl;
                        link.download = `UniversalDAW_Track_${index + 1}_${track.name}_${Date.now()}.wav`;
                        link.style.display = 'none';
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        downloadCount++;
                        if (downloadCount === audioTracks.length) {
                            alert(`Downloaded ${audioTracks.length} tracks. In a full DAW, these would be mixed together.`);
                        }
                    }, index * 500); // Stagger downloads
                });
            }
        }

        // TRACK CONTROLS
        function toggleMute(button) {
            button.classList.toggle('active');
            button.textContent = button.classList.contains('active') ? 'üîä Unmute' : 'üîá Mute';
        }

        function toggleSolo(button) {
            button.classList.toggle('active');
            button.textContent = button.classList.contains('active') ? 'üîá Unsolo' : 'üéµ Solo';
        }

        function deleteTrack(trackId) {
            if (confirm('Are you sure you want to delete this track?')) {
                const track = document.getElementById(trackId);
                if (track) {
                    track.remove();
                    
                    // Remove from allTracks array
                    allTracks = allTracks.filter(t => t.id !== trackId);
                    
                    console.log('Track deleted:', trackId);
                }
            }
        }

        function recordTrack(button) {
            document.getElementById('recordBtn').click();
        }

        // TRANSPORT CONTROLS
        document.getElementById('playBtn').addEventListener('click', function() {
            isPlaying = !isPlaying;
            this.textContent = isPlaying ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
            this.classList.toggle('active', isPlaying);
            
            if (isPlaying) {
                startPlayback();
            } else {
                stopPlayback();
            }
        });

        document.getElementById('stopBtn').addEventListener('click', function() {
            isPlaying = false;
            playbackTime = 0;
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Play';
            document.getElementById('playBtn').classList.remove('active');
            stopPlayback();
            updateTimeDisplay();
        });

        function startPlayback() {
            console.log('Starting playback...');
            playInterval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(playInterval);
                    return;
                }
                playbackTime += 0.1;
                updateTimeDisplay();
            }, 100);
        }

        function stopPlayback() {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
            
            // Stop all playing audio
            if (currentlyPlayingAudio) {
                currentlyPlayingAudio.pause();
                currentlyPlayingAudio.currentTime = 0;
                currentlyPlayingAudio = null;
                
                // Reset play buttons
                document.querySelectorAll('.track-btn').forEach(btn => {
                    if (btn.textContent.includes('‚è∏Ô∏è')) {
                        btn.textContent = '‚ñ∂Ô∏è Play';
                        btn.classList.remove('active');
                    }
                });
                
                currentPlayButton = null;
            }
        }

        function updateTimeDisplay() {
            const minutes = Math.floor(playbackTime / 60);
            const seconds = Math.floor(playbackTime % 60);
            document.getElementById('timeDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // OTHER CONTROLS
        document.getElementById('addTrackBtn').addEventListener('click', function() {
            addTrack('audio');
        });

        document.getElementById('mainAddTrackBtn').addEventListener('click', function() {
            addTrack('audio');
        });

        document.getElementById('vocalEffectsBtn').addEventListener('click', function() {
            alert('Vocal Effects Panel:\n\n‚Ä¢ Noise Reduction\n‚Ä¢ De-esser\n‚Ä¢ Compression\n‚Ä¢ EQ\n‚Ä¢ Reverb\n‚Ä¢ Pitch Correction\n\nThese effects would be applied to enhance your vocal recordings.');
        });

        document.getElementById('splitToolBtn').addEventListener('click', function() {
            alert('Split Tool: Click on any track to split it at the current position.');
        });

        document.getElementById('copyToolBtn').addEventListener('click', function() {
            alert('Copy Tool: Select a region and click this to copy it.');
        });

        document.getElementById('pasteToolBtn').addEventListener('click', function() {
            alert('Paste Tool: Click this to paste copied audio at the current position.');
        });

        document.getElementById('deleteToolBtn').addEventListener('click', function() {
            alert('Delete Tool: Select a region and click this to delete it.');
        });

        // MASTER CONTROLS
        document.getElementById('masterVolume').addEventListener('input', function() {
            console.log('Master volume:', this.value);
            // In a real DAW, this would control global volume
        });

        document.getElementById('bpmInput').addEventListener('change', function() {
            console.log('BPM changed to:', this.value);
        });

        // KEYBOARD SHORTCUTS
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                document.getElementById('playBtn').click();
            } else if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                document.getElementById('splitToolBtn').click();
            } else if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                alert('Undo last action');
            }
        });

        // INITIALIZATION
        window.addEventListener('load', function() {
            console.log('Universal DAW loading...');
            initAudioContext();
            addTrack('audio'); // Add first track
            console.log('Universal DAW ready!');
            
            // Welcome message
            setTimeout(() => {
                console.log('üéµ Universal DAW is ready! Try importing audio or recording.');
            }, 1000);
        });

        // ERROR HANDLING
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });

        // DEBUG INFO
        console.log('Universal DAW v2.0 - Enhanced with working audio playback and file upload');
        console.log('Features: File Upload, Audio Playback, Recording, Beat Maker, Export');
    </script>
</body>
</html>
